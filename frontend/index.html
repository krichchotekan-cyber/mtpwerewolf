
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MTP WEREWOLF ONLINE - ‡πÄ‡∏Å‡∏°‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Kanit', sans-serif;
  }

  body {
    min-height: 100vh;
    background-color: #3f3535;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    color: #f5f5dc;
    display: flex;
    flex-direction: column;
    transition: background-image 0.8s ease;
  }
  
  body.day { 
    background-image: url('img/Day.png');
  }
  
  body.night { 
    background-image: url('img/Night.png');
  }

  @keyframes shakeCard {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(0); }
    75% { transform: translateX(5px); }
  }

  .shake-animation {
    animation: shakeCard 0.5s ease-in-out;
  }

  header {
    background: rgba(15, 10, 10, 0.85);
    padding: 1rem 2rem;
    display: flex;
    justify-content: center;
    align-items: center;
    border-bottom: 4px solid #8b4513;
    box-shadow: 0 4px 15px rgba(0,0,0,0.6);
    position: relative;
  }

  .header-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    width: 100%;
    max-width: 1000px;
  }

  header h1 {
    font-size: 2.2rem;
    color: #ffeb3b;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
    text-align: center;
  }

  .connection-status {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    z-index: 9999;
    font-weight: bold;
  }

  .connected {
    background: #4caf50;
    color: white;
  }

  .disconnected {
    background: #f44336;
    color: white;
  }

  .timer-display {
    background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,20,20,0.8));
    color: #ffeb3b;
    padding: 0.8rem 1.2rem;
    border-radius: 15px;
    border: 2px solid #b7905b;
    font-size: 1rem;
    font-weight: bold;
    text-align: center;
    min-width: 120px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.6);
  }
  
  .timer-display .timer-label {
    font-size: 0.8rem;
    opacity: 0.8;
    margin-bottom: 0.3rem;
  }
  
  .timer-display .timer-time {
    font-size: 1.4rem;
    color: #ff6b6b;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
  }

  .container {
    flex: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    width: 100%;
  }

  .lobby-section {
    display: block;
  }

  .user-info {
    background: rgba(0,0,0,0.3);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    border: 2px solid #8b4513;
    backdrop-filter: blur(10px);
  }

  .nickname-input {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .nickname-input input {
    flex: 1;
    padding: 0.8rem;
    border: 2px solid #5d4037;
    border-radius: 8px;
    background: #f5f5dc;
    color: #333;
    font-size: 1rem;
  }

  .btn {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
    transition: all 0.3s ease;
    font-family: 'Kanit', sans-serif;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-primary {
    background: linear-gradient(135deg, #4caf50, #45a049);
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
  }

  .btn-danger {
    background: linear-gradient(135deg, #ff4444, #cc0000);
    color: white;
  }

  .btn-danger:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4);
  }

  .btn-secondary {
    background: linear-gradient(135deg, #666, #444);
    color: white;
  }

  .btn-secondary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 102, 102, 0.4);
  }

  .room-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .create-room-form {
    background: rgba(0,0,0,0.5);
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    border: 2px solid #8b4513;
    backdrop-filter: blur(10px);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .form-group label {
    font-weight: bold;
    color: #ffeb3b;
  }

  .form-group input, .form-group select {
    padding: 0.8rem;
    border: 2px solid #5d4037;
    border-radius: 8px;
    background: #f5f5dc;
    color: #333;
    font-size: 1rem;
  }

  .form-row {
    display: flex;
    gap: 1rem;
  }

  .form-row .form-group {
    flex: 1;
  }

  .rooms-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
  }

  .room-card {
    background: rgba(0,0,0,0.5);
    border: 2px solid #8b4513;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .room-card:hover {
    transform: translateY(-5px);
    border-color: #ffeb3b;
    box-shadow: 0 8px 25px rgba(255, 235, 59, 0.3);
  }

  .room-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .room-name {
    font-size: 1.3rem;
    font-weight: bold;
    color: #ffeb3b;
  }

  .room-status {
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
  }

  .status-waiting {
    background: #4caf50;
    color: white;
  }

  .status-playing {
    background: #ff9800;
    color: white;
  }

  .status-full {
    background: #f44336;
    color: white;
  }

  .room-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }

  .players-info {
    color: #ccc;
  }

  .room-host {
    color: #ffeb3b;
    font-weight: bold;
  }

  .join-btn {
    width: 100%;
    margin-top: 1rem;
  }

  .game-room-section {
    display: none;
  }

  .moderator-section {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 1rem;
    justify-content: center;
  }

  .moderator-avatar {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #ff9800, #f57c00);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    border: 3px solid #fff;
    box-shadow: 0 4px 15px rgba(0,0,0,0.6);
    flex-shrink: 0;
  }

  .speech-bubble {
    background: linear-gradient(135deg, #fff, #f5f5f5);
    color: #333;
    padding: 1rem 1.5rem;
    border-radius: 20px;
    position: relative;
    max-width: 500px;
    font-size: 0.95rem;
    line-height: 1.4;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    animation: float 3s ease-in-out infinite;
  }

  .speech-bubble::before {
    content: '';
    position: absolute;
    left: -10px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-right: 15px solid #fff;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-5px); }
  }

  .room-header-info {
    background: rgba(0,0,0,0.5);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    border: 2px solid #8b4513;
    text-align: center;
    backdrop-filter: blur(10px);
  }

  .room-title {
    font-size: 1.8rem;
    color: #ffeb3b;
    margin-bottom: 0.5rem;
  }

  .room-details {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1rem;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
  }

  .detail-label {
    font-size: 0.8rem;
    opacity: 0.8;
  }

  .detail-value {
    font-weight: bold;
    color: #ffeb3b;
  }

  .game-phase-indicator {
    background: rgba(0,0,0,0.6);
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    border: 2px solid #8b4513;
    text-align: center;
    backdrop-filter: blur(10px);
  }

  .phase-title {
    font-size: 2rem;
    color: #ffeb3b;
    margin-bottom: 0.5rem;
  }

  .players-in-room {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .player-in-room {
    background: rgba(0,0,0,0.4);
    padding: 1rem;
    border-radius: 12px;
    border: 3px solid #8b4513;
    text-align: center;
    position: relative;
    transition: all 0.3s ease;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
  }

  .player-card-img {
    width: 90px;
    height: 125px;
    background: url('img/Backcard.png') center/cover no-repeat;
    border-radius: 8px;
    border: 2px solid #a78517;
    box-shadow: 0 4px 15px rgba(0,0,0,0.7);
    margin-bottom: 0.5rem;
    transition: all 0.6s ease;
    position: relative;
  }

  .player-in-room.dead .player-card-img {
    background-image: url('img/Backcard.png') !important;
    filter: brightness(0.3) grayscale(100%);
    transform: rotateY(180deg) rotate(-15deg);
  }

  .player-in-room.dead {
    opacity: 0.6;
  }

  .player-in-room.dead::after {
    content: "üíÄ";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    z-index: 2;
    animation: deathPulse 2s ease-in-out infinite;
  }

  @keyframes deathPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
  }

  .player-in-room.host {
    border-color: #ffeb3b;
  }

  .player-in-room.host::before {
    content: "üëë";
    position: absolute;
    top: -10px;
    right: -10px;
    background: #ffeb3b;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    z-index: 3;
  }

  .player-in-room.selectable {
    cursor: pointer;
    border-color: #4caf50;
  }

  .player-in-room.selectable:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
  }

  .player-in-room.selectable:hover .player-card-img {
    transform: translateY(-5px);
  }

  .player-in-room.selected {
    border-color: #ff9800;
    background: rgba(255, 152, 0, 0.3);
  }

  .player-name {
    font-weight: bold;
    color: #f5f5dc;
    font-size: 0.9rem;
  }

  .player-ready {
    margin-top: 0.5rem;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
  }

  .ready {
    background: #4caf50;
    color: white;
  }

  .not-ready {
    background: #f44336;
    color: white;
  }

  .game-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
    margin: 2rem 0;
  }

  .role-assignment {
    background: rgba(0,0,0,0.6);
    border: 2px solid #8b4513;
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    text-align: center;
    backdrop-filter: blur(10px);
  }

  .your-role {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: #ffeb3b;
  }

  .role-card-display {
    width: 200px;
    height: 280px;
    margin: 0 auto 1rem;
    border-radius: 15px;
    border: 3px solid #ffeb3b;
    box-shadow: 0 8px 25px rgba(0,0,0,0.5);
    perspective: 800px;
    cursor: pointer;
    position: relative;
  }

  .role-card-display .card-inner {
    width: 100%;
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  .role-card-display.flipped .card-inner {
    transform: rotateY(180deg);
  }

  .role-card-display .card-face {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 12px;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  .role-card-display .card-back {
    background-image: url('img/Backcard.png');
  }

  .role-card-display .card-front {
    transform: rotateY(180deg);
  }

  .role-description {
    font-size: 1rem;
    line-height: 1.5;
    color: #ccc;
    max-width: 600px;
    margin: 0 auto;
  }

  .shake {
    animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    transform: translate3d(0, 0, 0);
    backface-visibility: hidden;
    perspective: 1000px;
  }

  @keyframes shake {
    10%, 90% {
      transform: translate3d(-1px, 0, 0);
    }
    
    20%, 80% {
      transform: translate3d(2px, 0, 0);
    }

    30%, 50%, 70% {
      transform: translate3d(-4px, 0, 0);
    }

    40%, 60% {
      transform: translate3d(4px, 0, 0);
    }
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  .modal.show {
    display: flex;
  }

  .modal-content {
    background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
    border: 2px solid #8b4513;
    border-radius: 15px;
    padding: 20px;
    width: 90%;
    max-width: 500px;
    animation: modalAppear 0.3s ease-out;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
  }

  @keyframes modalAppear {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-header {
    border-bottom: 2px solid #8b4513;
    padding-bottom: 15px;
    margin-bottom: 15px;
  }

  .modal-header h2 {
    margin: 0;
    color: #ffeb3b;
    font-size: 1.5rem;
    text-align: center;
  }

  .modal-body {
    color: #f5f5dc;
    text-align: center;
  }

  .modal-body p {
    margin: 15px 0;
    font-size: 1.1rem;
    line-height: 1.4;
  }

  .modal-footer {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 15px;
  }

  .modal-footer button {
    min-width: 120px;
  }

  .team-indicator {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: bold;
    margin-top: 1rem;
  }

  .team-villager {
    background: linear-gradient(135deg, #4caf50, #45a049);
    color: white;
  }

  .team-werewolf {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
  }

  .team-neutral {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    color: white;
  }

  .action-area {
    background: rgba(0,0,0,0.6);
    border: 2px solid #8b4513;
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    text-align: center;
    backdrop-filter: blur(10px);
  }

  .action-title {
    font-size: 1.5rem;
    color: #ffeb3b;
    margin-bottom: 1rem;
  }

  .action-instruction {
    font-size: 1rem;
    color: #ccc;
    margin-bottom: 1.5rem;
  }

  .game-log {
    background: rgba(0,0,0,0.6);
    border: 2px solid #8b4513;
    border-radius: 12px;
    padding: 1.5rem;
    margin: 2rem 0;
    max-height: 300px;
    overflow-y: auto;
    backdrop-filter: blur(10px);
  }

  .game-log-title {
    font-size: 1.2rem;
    color: #ffeb3b;
    margin-bottom: 1rem;
    position: sticky;
    top: 0;
    background: rgba(0,0,0,0.9);
    padding: 0.5rem 0;
  }

  .log-entry {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 5px;
    background: rgba(255,255,255,0.05);
  }

  .log-entry.important {
    background: rgba(255, 152, 0, 0.2);
    border-left: 3px solid #ff9800;
  }

  .message {
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    text-align: center;
    animation: fadeIn 0.5s ease-in-out;
    backdrop-filter: blur(5px);
  }

  .message-success {
    background: rgba(76, 175, 80, 0.3);
    border: 1px solid #4caf50;
    color: #4caf50;
  }

  .message-error {
    background: rgba(244, 67, 54, 0.3);
    border: 1px solid #f44336;
    color: #f44336;
  }

  .message-info {
    background: rgba(33, 150, 243, 0.3);
    border: 1px solid #2196f3;
    color: #2196f3;
  }

  .hidden {
    display: none !important;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  footer {
    text-align: center;
    padding: 1rem;
    color: #f5f5dc;
    background: rgba(15, 10, 10, 0.85);
    border-top: 2px solid #8b4513;
  }

  @media (max-width: 768px) {
    .container {
      padding: 1rem;
    }
    
    header h1 {
      font-size: 1.8rem;
    }
    
    .form-row {
      flex-direction: column;
    }
    
    .rooms-list {
      grid-template-columns: 1fr;
    }
    
    .players-in-room {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1rem;
    }

    .player-card-img {
      width: 70px;
      height: 100px;
    }
    
    .game-controls {
      flex-direction: column;
    }
    
    .room-details {
      flex-direction: column;
      gap: 0.5rem;
    }

    .moderator-avatar {
      width: 50px;
      height: 50px;
      font-size: 1.5rem;
    }

    .speech-bubble {
      max-width: 300px;
      font-size: 0.85rem;
    }

    .timer-display {
      font-size: 0.9rem;
      padding: 0.6rem 1rem;
    }
  }
</style>
</head>
<body class="day">
  <div class="connection-status disconnected" id="connectionStatus">üî¥ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
  
  <header>
    <div class="header-content">
      <h1>üê∫ MTP WEREWOLF ONLINE üåô</h1>
      <div class="timer-display hidden" id="timerDisplay">
        <div class="timer-label">‡πÄ‡∏ü‡∏™‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
        <div class="timer-time" id="timerTime">--:--</div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="lobby-section" id="lobbySection">
      <div class="user-info">
        <div class="nickname-input">
          <input type="text" id="nicknameInput" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" maxlength="12">
          <button class="btn btn-primary" onclick="setNickname()">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠</button>
        </div>
        <div id="currentUser" class="hidden" style="margin-top: 1rem;">
          ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: <span id="userDisplay" style="color: #ffeb3b; font-weight: bold;"></span>
        </div>
      </div>

      <div class="room-actions" id="roomActions" style="display: none;">
        <button class="btn btn-primary" onclick="showCreateRoomForm()">üè† ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
        <button class="btn btn-secondary" onclick="refreshRooms()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      </div>

      <div class="create-room-form hidden" id="createRoomForm">
        <h3 style="color: #ffeb3b; margin-bottom: 1rem;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="roomName">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á</label>
            <input type="text" id="roomName" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á" maxlength="20">
          </div>
          <div class="form-group">
            <label for="maxPlayers">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</label>
            <select id="maxPlayers">
              <option value="5">5 ‡∏Ñ‡∏ô</option>
              <option value="6">6 ‡∏Ñ‡∏ô</option>
              <option value="7">7 ‡∏Ñ‡∏ô</option>
              <option value="8">8 ‡∏Ñ‡∏ô</option>
              <option value="9">9 ‡∏Ñ‡∏ô</option>
              <option value="10">10 ‡∏Ñ‡∏ô</option>
              <option value="11">11 ‡∏Ñ‡∏ô</option>
              <option value="12">12 ‡∏Ñ‡∏ô</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="roomPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
          <input type="password" id="roomPassword" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£" maxlength="10">
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button class="btn btn-primary" onclick="createRoom()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
          <button class="btn btn-secondary" onclick="hideCreateRoomForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      </div>

      <div id="roomsList">
        <h3 style="color: #ffeb3b; margin-bottom: 1rem;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á</h3>
        <div class="rooms-list" id="roomsContainer"></div>
      </div>
    </div>

    <div class="game-room-section" id="gameRoomSection">
      <div class="moderator-section">
        <div class="moderator-avatar">üé≠</div>
        <div class="speech-bubble" id="moderatorMessage">
          ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏Å‡∏°‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤!
        </div>
      </div>

      <div class="room-header-info">
        <div class="room-title" id="currentRoomName">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏°</div>
        <div class="room-details">
          <div class="detail-item">
            <div class="detail-label">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
            <div class="detail-value" id="playerCount">0/0</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div class="detail-value" id="gameStatus">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</div>
            <div class="detail-value" id="roomOwner">-</div>
          </div>
        </div>
      </div>

      <div class="game-phase-indicator hidden" id="gamePhaseIndicator">
        <div class="phase-title" id="phaseTitle">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</div>
      </div>

      <div class="players-in-room" id="playersInRoom"></div>

      <div class="game-controls">
        <button class="btn btn-primary" id="readyBtn" onclick="toggleReady()">‡∏û‡∏£‡πâ‡∏≠‡∏°</button>
        <button class="btn btn-primary hidden" id="startGameBtn" onclick="startGame()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
        <button class="btn btn-danger" onclick="leaveRoom()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
      </div>

      <div class="role-assignment hidden" id="roleAssignment">
        <div class="your-role">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
        <div class="role-card-display" id="roleCardDisplay" onclick="flipRoleCard()">
          <div class="card-inner">
            <div class="card-face card-back"></div>
            <div class="card-face card-front" id="roleCardFront"></div>
          </div>
        </div>
        <div class="role-description" id="roleDescription"></div>
        <div class="team-indicator" id="teamIndicator"></div>
        <div id="werewolfTeam" class="hidden" style="margin-top: 1rem;"></div>
      </div>

      <div class="action-area hidden" id="actionArea">
        <div class="action-title" id="actionTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</div>
        <div class="action-instruction" id="actionInstruction">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>
        <button class="btn btn-primary" id="confirmActionBtn" onclick="confirmAction()" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</button>
      </div>

      <div class="game-log hidden" id="gameLog">
        <div class="game-log-title">üìú ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</div>
        <div id="gameLogContent"></div>
      </div>

      <div id="gameMessages"></div>
    </div>

    <div id="messages"></div>
  </div>

  <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï -->
  <div class="modal" id="voteConfirmModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</h2>
      </div>
      <div class="modal-body">
        <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï‡πÉ‡∏´‡πâ <span class="vote-target-name" style="color: #ffeb3b; font-weight: bold;"></span> ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelVoteBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-primary" id="confirmVoteBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      </div>
    </div>
  </div>

  <!-- Modal ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô -->
  <div class="modal" id="judgmentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üî• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏ß‡∏ï</h2>
      </div>
      <div class="modal-body">
        <h3 class="voted-player-name" style="color: #ffeb3b; margin-bottom: 1rem;"></h3>
        <img src="img/Backcard.png" alt="Player Card" id="votedPlayerCard" class="player-card-img" style="width: 150px; height: 210px; margin: 0 auto 1rem; display: block;">
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="forgiveBtn">üïäÔ∏è ‡πÉ‡∏´‡πâ‡∏≠‡∏†‡∏±‡∏¢</button>
        <button class="btn btn-danger" id="burnBtn">üî• ‡πÄ‡∏ú‡∏≤</button>
      </div>
    </div>
  </div>

  <footer>
    <p>DEV l <strong>KRIT.KISS MTP</strong></p>
  </footer>

<script>
const SERVER_URL = 'http://localhost:3000';

const roleCardImages = {
  'Villager': 'img/Villager2.png',
  'Seer': 'img/Seer.png',
  'Bodyguard': 'img/Bodyguard.png',
  'Werewolf': 'img/Wolf.png',
  'Witch': 'img/Witch.png',
  'Wizard': 'img/Sorcerer.png',
  'Hunter': 'img/Hunter.png',
  'Prostitute': 'img/Bitch.png',
  'Wolf Cub': 'img/Babywolf.png',
  'Mermaid': 'img/Silent.png',
  'Minion': 'img/Labour.png',
  'Village Drunk': 'img/Drunker.png'
};

let socket;
let gameState = {
  currentUser: null,
  currentRoom: null,
  isReady: false,
  userRole: null,
  selectedPlayer: null,
  gamePhase: 'lobby',
  inRoom: false,
  hasVoted: false,
  isConnected: false
};
let phaseTimer = null;

const moderatorMessages = {
  lobby: [
    "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏Å‡∏°‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤! ‡∏£‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°",
    "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢... ‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ",
    "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á? ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞"
  ],
  day: [
    "üåÖ ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤! ‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ï‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞",
    "‚òÄÔ∏è ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏ä‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà! ‡∏°‡∏≤‡∏î‡∏π‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡πâ‡∏≤‡∏á",
    "üåÑ ‡πÅ‡∏™‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡πÑ‡∏î‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏≤‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏Å‡∏±‡∏ô"
  ],
  night: [
    "üåô ‡∏Ñ‡πà‡∏≥‡∏Ñ‡∏∑‡∏ô‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö... ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏ï‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß",
    "üåÉ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏¥‡∏ó",
    "‚≠ê ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß... ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢"
  ],
  gameStart: [
    "üéÆ ‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ",
    "üé≤ ‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞! ‡πÉ‡∏Ñ‡∏£‡∏à‡∏∞‡∏£‡∏≠‡∏î ‡πÉ‡∏Ñ‡∏£‡∏à‡∏∞‡∏ï‡∏≤‡∏¢?",
    "üéØ ‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡∏ß‡∏≤‡∏á‡πÉ‡∏à‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡πà‡∏á"
  ]
};

function getRandomMessage(category) {
  const messages = moderatorMessages[category] || moderatorMessages.lobby;
  return messages[Math.floor(Math.random() * messages.length)];
}

function updateModeratorMessage(category) {
  const message = getRandomMessage(category);
  const moderatorElement = document.getElementById('moderatorMessage');
  if (moderatorElement) {
    moderatorElement.textContent = message;
  }
}

function initSocket() {
  if (socket && socket.connected) {
    socket.disconnect();
  }
  
  socket = io(SERVER_URL);
  
  socket.on('connect', () => {
    console.log('Connected to server');
    gameState.isConnected = true;
    updateConnectionStatus(true);
  });
  
  socket.on('disconnect', () => {
    console.log('Disconnected from server');
    gameState.isConnected = false;
    updateConnectionStatus(false);
    showMessage('‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'error');
  });

  socket.on('connect_error', () => {
    gameState.isConnected = false;
    updateConnectionStatus(false);
    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
  });
  
  socket.on('roomUpdate', (room) => {
    if (gameState.inRoom && room) {
      gameState.currentRoom = room;
      updateGameRoomDisplay(room);
    }
  });
  
  socket.on('roomsUpdate', () => {
    if (!gameState.inRoom) {
      refreshRooms();
    }
  });
  
  socket.on('playerJoined', (data) => {
    if (data && data.nickname) {
      addGameLog(`‚úÖ ${data.nickname} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á`);
    }
  });
  
  socket.on('playerLeft', (data) => {
    if (data && data.nickname) {
      addGameLog(`‚ùå ${data.nickname} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á`);
    }
  });
  
  socket.on('roomClosed', () => {
    showMessage('‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á', 'info');
    resetGameState();
    switchToLobby();
  });
  
  socket.on('roleAssigned', (role) => {
    if (role) {
      gameState.userRole = role;
      showRoleAssignment(role);
      setTimeout(() => {
        flipRoleCard();
      }, 1000);
    }
  });

  socket.on('gameStarted', (data) => {
    if (data && data.room) {
      gameState.gamePhase = 'game';
      document.getElementById('gameLog').classList.remove('hidden');
      document.getElementById('timerDisplay').classList.remove('hidden');
      addGameLog('üéÆ ‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô!', true);
      updateGameRoomDisplay(data.room);
      updateModeratorMessage('gameStart');
      document.body.classList.add('day');
      document.body.classList.remove('night');
      
      if (phaseTimer) clearInterval(phaseTimer);
      if (data.duration) {
        startPhaseTimer(data.duration);
      }
    }
  });

  socket.on('phaseChange', (data) => {
    if (data && data.phase) {
      gameState.gamePhase = data.phase;
      document.getElementById('timerDisplay').classList.remove('hidden');
      
      if (phaseTimer) clearInterval(phaseTimer);
      if (data.duration) {
        startPhaseTimer(data.duration);
      }
      
      if (data.phase === 'night') {
        startNightPhase(data.dayNumber || 1);
        document.body.classList.add('night');
        document.body.classList.remove('day');
        updateModeratorMessage('night');
      } else if (data.phase === 'day') {
        startDayPhase(data.dayNumber || 1);
        document.body.classList.add('day');
        document.body.classList.remove('night');
        updateModeratorMessage('day');
      } else if (data.phase === 'voting') {
        startVotingPhase();
      }
    }
  });
  
  socket.on('investigateResult', (data) => {
    if (data && data.target && gameState.currentRoom) {
      const player = gameState.currentRoom.players.find(p => p.id === data.target);
      if (player) {
        const result = data.isWerewolf ? '‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤ üê∫' : '‡∏Ñ‡∏ô‡∏î‡∏µ ‚úÖ';
        showMessage(`üîÆ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ${player.nickname} ‡πÄ‡∏õ‡πá‡∏ô${result}`, data.isWerewolf ? 'error' : 'success');
        addGameLog(`üîÆ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ${player.nickname}: ${result}`);
      }
    }
  });
  
  socket.on('playerDied', (data) => {
    if (data && data.nickname) {
      addGameLog(`üíÄ ${data.nickname} ‡∏ñ‡∏π‡∏Å‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡πÉ‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ!`, true);
      updateModeratorMessage('day');
      setTimeout(() => {
        const moderatorElement = document.getElementById('moderatorMessage');
        if (moderatorElement) {
          moderatorElement.textContent = `üò± ‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡πâ‡∏≤‡∏¢! ${data.nickname} ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤...`;
        }
      }, 1000);
    }
  });
  
  socket.on('playerProtected', () => {
    addGameLog(`üõ°Ô∏è ‡∏ö‡∏≠‡∏î‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏Ñ‡∏£‡∏™‡∏±‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ!`, true);
  });
  
  socket.on('playerVotedOut', (data) => {
    if (!data || !data.nickname) {
      console.error('Invalid playerVotedOut data:', data);
      return;
    }

    const modal = document.getElementById('judgmentModal');
    const playerNameEl = modal.querySelector('.voted-player-name');
    const playerCard = document.getElementById('votedPlayerCard');
    const forgiveBtn = document.getElementById('forgiveBtn');
    const burnBtn = document.getElementById('burnBtn');

    if (!modal || !playerNameEl || !playerCard || !forgiveBtn || !burnBtn) {
      console.error('Required DOM elements not found');
      return;
    }

    function cleanup() {
      forgiveBtn.removeEventListener('click', handleForgive);
      burnBtn.removeEventListener('click', handleBurn);
      modal.removeEventListener('click', handleOutsideClick);
      playerCard.classList.remove('card-flip');
    }

    function handleForgive() {
      socket.emit('judgmentVote', { target: data.id, vote: 'forgive' });
      addGameLog(`üïäÔ∏è ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏≠‡∏†‡∏±‡∏¢ ${data.nickname}`, true);
      showMessage(`${data.nickname} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏†‡∏±‡∏¢`, 'info');
      modal.classList.remove('show');
      cleanup();
    }

    function handleBurn() {
      socket.emit('judgmentVote', { target: data.id, vote: 'burn' });
      playerCard.classList.add('card-flip');
      setTimeout(() => {
        const roleImage = (data.role && roleCardImages[data.role.nameEn]) ? roleCardImages[data.role.nameEn] : 'img/Backcard.png';
        playerCard.src = roleImage;
        addGameLog(`‚öñÔ∏è ${data.nickname} ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏ß‡∏ï‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢ ${data.votes || 0} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, true);
        if (data.role) {
          addGameLog(`üíÄ ${data.nickname} ‡∏°‡∏µ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏õ‡πá‡∏ô ${data.role.name} ${data.role.icon || ''}`);
        }
      }, 500);
      setTimeout(() => {
        modal.classList.remove('show');
        cleanup();
      }, 3000);
    }

    function handleOutsideClick(e) {
      if (e.target === modal) {
        modal.classList.remove('show');
        cleanup();
      }
    }

    playerNameEl.textContent = `${data.nickname} (${data.votes || 0} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)`;
    playerCard.src = 'img/Backcard.png';
    playerCard.classList.remove('card-flip');
    modal.classList.add('show');

    forgiveBtn.addEventListener('click', handleForgive);
    burnBtn.addEventListener('click', handleBurn);
    modal.addEventListener('click', handleOutsideClick);
  });

  socket.on('voteVoid', (data) => {
    if (data && data.message) {
      showMessage(data.message, 'info');
      addGameLog('‚öñÔ∏è ' + data.message, true);
    }
  });

  socket.on('voteUpdate', (data) => {
    if (data) {
      console.log('Vote update:', data.votes, data.totalVoted, data.totalPlayers);
    }
  });
  
  socket.on('gameEnded', (data) => {
    if (data && data.message) {
      gameState.gamePhase = 'ended';
      document.getElementById('gamePhaseIndicator').classList.remove('hidden');
      document.getElementById('phaseTitle').textContent = data.message;
      addGameLog(data.message, true);
      showMessage(data.message, data.winner === 'villager' ? 'success' : 'error');
      document.getElementById('actionArea').classList.add('hidden');
      
      const moderatorElement = document.getElementById('moderatorMessage');
      if (moderatorElement) {
        moderatorElement.textContent = data.message;
      }
      
      if (phaseTimer) {
        clearInterval(phaseTimer);
        phaseTimer = null;
      }
    }
  });

  socket.on('error', (error) => {
    console.error('Socket error:', error);
    showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (error.message || 'Unknown error'), 'error');
  });
}

function resetGameState() {
  gameState.inRoom = false;
  gameState.currentRoom = null;
  gameState.isReady = false;
  gameState.userRole = null;
  gameState.gamePhase = 'lobby';
  gameState.selectedPlayer = null;
  gameState.hasVoted = false;
  
  if (phaseTimer) {
    clearInterval(phaseTimer);
    phaseTimer = null;
  }
  
  document.body.classList.remove('night');
  document.body.classList.add('day');
}

function updateConnectionStatus(connected) {
  const status = document.getElementById('connectionStatus');
  if (status) {
    if (connected) {
      status.textContent = 'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
      status.className = 'connection-status connected';
    } else {
      status.textContent = 'üî¥ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
      status.className = 'connection-status disconnected';
    }
  }
}

function showMessage(text, type = 'info') {
  if (!text) return;
  
  const messagesDiv = document.getElementById('messages');
  if (!messagesDiv) return;
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message message-${type}`;
  messageDiv.textContent = text;
  messagesDiv.appendChild(messageDiv);
  
  setTimeout(() => {
    if (messageDiv.parentNode) {
      messageDiv.parentNode.removeChild(messageDiv);
    }
  }, 5000);
}

function addGameLog(text, important = false) {
  if (!text) return;
  
  const logContent = document.getElementById('gameLogContent');
  if (!logContent) return;
  
  const entry = document.createElement('div');
  entry.className = `log-entry ${important ? 'important' : ''}`;
  const time = new Date().toLocaleTimeString('th-TH');
  entry.innerHTML = `<span style="opacity: 0.7;">[${time}]</span> ${text}`;
  logContent.appendChild(entry);
  logContent.scrollTop = logContent.scrollHeight;
}

function setNickname() {
  const nicknameInput = document.getElementById('nicknameInput');
  if (!nicknameInput) return;
  
  const nickname = nicknameInput.value.trim();
  
  if (!nickname) {
    showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô', 'error');
    return;
  }
  
  if (nickname.length < 2 || nickname.length > 12) {
    showMessage('‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 2-12 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'error');
    return;
  }

  if (!gameState.isConnected) {
    showMessage('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'error');
    return;
  }
  
  socket.emit('setNickname', nickname, (response) => {
    if (response && response.success) {
      gameState.currentUser = nickname;
      const userDisplay = document.getElementById('userDisplay');
      const currentUser = document.getElementById('currentUser');
      const roomActions = document.getElementById('roomActions');
      
      if (userDisplay) userDisplay.textContent = nickname;
      if (currentUser) currentUser.classList.remove('hidden');
      if (nicknameInput) nicknameInput.style.display = 'none';
      
      const nicknameBtn = document.querySelector('.nickname-input button');
      if (nicknameBtn) nicknameBtn.style.display = 'none';
      if (roomActions) roomActions.style.display = 'flex';
      
      showMessage(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${nickname}!`, 'success');
      refreshRooms();
    } else {
      showMessage(response?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ', 'error');
    }
  });
}

function showCreateRoomForm() {
  const form = document.getElementById('createRoomForm');
  if (form) {
    form.classList.remove('hidden');
  }
}

function hideCreateRoomForm() {
  const form = document.getElementById('createRoomForm');
  const roomName = document.getElementById('roomName');
  const roomPassword = document.getElementById('roomPassword');
  const maxPlayers = document.getElementById('maxPlayers');
  
  if (form) form.classList.add('hidden');
  if (roomName) roomName.value = '';
  if (roomPassword) roomPassword.value = '';
  if (maxPlayers) maxPlayers.value = '8';
}

function createRoom() {
  const roomName = document.getElementById('roomName');
  const maxPlayers = document.getElementById('maxPlayers');
  const password = document.getElementById('roomPassword');
  
  if (!roomName || !maxPlayers) return;
  
  const roomNameValue = roomName.value.trim();
  const maxPlayersValue = parseInt(maxPlayers.value);
  const passwordValue = password ? password.value.trim() : '';
  
  if (!roomNameValue) {
    showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á', 'error');
    return;
  }

  if (!gameState.isConnected) {
    showMessage('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'error');
    return;
  }
  
  socket.emit('createRoom', { 
    name: roomNameValue, 
    maxPlayers: maxPlayersValue, 
    password: passwordValue 
  }, (response) => {
    if (response && response.success && response.room) {
      gameState.currentRoom = response.room;
      gameState.inRoom = true;
      hideCreateRoomForm();
      switchToGameRoom();
      updateGameRoomDisplay(response.room);
      showMessage(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á "${roomNameValue}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
      updateModeratorMessage('lobby');
    } else {
      showMessage(response?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
    }
  });
}

function refreshRooms() {
  if (!gameState.isConnected) {
    showMessage('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'error');
    return;
  }
  
  socket.emit('getRooms', (rooms) => {
    const container = document.getElementById('roomsContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!rooms || rooms.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; color: #ccc; grid-column: 1 / -1;">
          <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏°</p>
          <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô!</p>
        </div>
      `;
      return;
    }
    
    rooms.forEach(room => {
      if (room) {
        const card = createRoomCard(room);
        container.appendChild(card);
      }
    });
  });
}

function createRoomCard(room) {
  if (!room) return document.createElement('div');
  
  const card = document.createElement('div');
  card.className = 'room-card';
  
  const isFull = (room.playerCount || 0) >= (room.maxPlayers || 0);
  
  let statusClass, statusText;
  if (room.gameStarted) {
    statusClass = 'status-playing';
    statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô';
  } else if (isFull) {
    statusClass = 'status-full';
    statusText = '‡πÄ‡∏ï‡πá‡∏°';
  } else {
    statusClass = 'status-waiting';
    statusText = '‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
  }
  
  card.innerHTML = `
    <div class="room-header">
      <div class="room-name">${room.name || 'Unknown Room'} ${room.hasPassword ? 'üîí' : ''}</div>
      <div class="room-status ${statusClass}">${statusText}</div>
    </div>
    <div class="room-info">
      <div class="players-info">üë• ${room.playerCount || 0}/${room.maxPlayers || 0}</div>
      <div class="room-host">üéÆ ${room.hostNickname || 'Unknown'}</div>
    </div>
    <button class="btn btn-primary join-btn" onclick="joinRoom('${room.id}')" 
            ${isFull || room.gameStarted ? 'disabled' : ''}>
      ${isFull ? '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°' : (room.gameStarted ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°')}
    </button>
  `;
  
  return card;
}

function joinRoom(roomId) {
  if (!roomId || !gameState.isConnected) {
    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
    return;
  }
  
  socket.emit('getRooms', (rooms) => {
    if (!rooms) {
      showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
      return;
    }
    
    const room = rooms.find(r => r && r.id === roomId);
    let password = null;
    
    if (room && room.hasPassword) {
      password = prompt('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á:');
      if (!password) return;
    }
    
    socket.emit('joinRoom', { roomId, password }, (response) => {
      if (response && response.success && response.room) {
        gameState.currentRoom = response.room;
        gameState.inRoom = true;
        switchToGameRoom();
        updateGameRoomDisplay(response.room);
        showMessage(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á "${response.room.name}" ‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
        updateModeratorMessage('lobby');
      } else {
        showMessage(response?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
      }
    });
  });
}

function leaveRoom() {
  if (!gameState.isConnected) {
    showMessage('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'error');
    return;
  }
  
  socket.emit('leaveRoom', (response) => {
    if (response && response.success) {
      resetGameState();
      switchToLobby();
      showMessage('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'info');
    } else {
      showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
    }
  });
}

function switchToGameRoom() {
  const lobbySection = document.getElementById('lobbySection');
  const gameRoomSection = document.getElementById('gameRoomSection');
  
  if (lobbySection) lobbySection.style.display = 'none';
  if (gameRoomSection) gameRoomSection.style.display = 'block';
}

function switchToLobby() {
  const lobbySection = document.getElementById('lobbySection');
  const gameRoomSection = document.getElementById('gameRoomSection');
  const roleAssignment = document.getElementById('roleAssignment');
  const gamePhaseIndicator = document.getElementById('gamePhaseIndicator');
  const actionArea = document.getElementById('actionArea');
  const gameLog = document.getElementById('gameLog');
  const timerDisplay = document.getElementById('timerDisplay');
  
  if (gameRoomSection) gameRoomSection.style.display = 'none';
  if (lobbySection) lobbySection.style.display = 'block';
  if (roleAssignment) roleAssignment.classList.add('hidden');
  if (gamePhaseIndicator) gamePhaseIndicator.classList.add('hidden');
  if (actionArea) actionArea.classList.add('hidden');
  if (gameLog) gameLog.classList.add('hidden');
  if (timerDisplay) timerDisplay.classList.add('hidden');
  
  refreshRooms();
}

function updateGameRoomDisplay(room) {
  if (!room) return;
  
  gameState.currentRoom = room;
  
  const currentRoomName = document.getElementById('currentRoomName');
  const playerCount = document.getElementById('playerCount');
  const gameStatus = document.getElementById('gameStatus');
  const roomOwner = document.getElementById('roomOwner');
  
  if (currentRoomName) currentRoomName.textContent = room.name || '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏°';
  if (playerCount) playerCount.textContent = `${room.playerCount || 0}/${room.maxPlayers || 0}`;
  if (gameStatus) gameStatus.textContent = room.gameStarted ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô' : '‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
  if (roomOwner) roomOwner.textContent = room.hostNickname || '-';
  
  const playersContainer = document.getElementById('playersInRoom');
  if (!playersContainer || !room.players) return;
  
  playersContainer.innerHTML = '';
  
  room.players.forEach((player, index) => {
    if (!player) return;
    
    const playerDiv = document.createElement('div');
    const isCurrentUser = player.nickname === gameState.currentUser;
    // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ voting phase ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏î‡πâ
    const canVote = gameState.gamePhase === 'voting' && !isCurrentUser && player.isAlive && !gameState.hasVoted;
    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô (night action)
    const canSelect = (gameState.gamePhase === 'night' && !isCurrentUser && player.isAlive && gameState.userRole) || canVote;

    playerDiv.className = `player-in-room ${player.isHost ? 'host' : ''} ${!player.isAlive ? 'dead' : ''} ${canSelect ? 'selectable' : ''}`;
    playerDiv.setAttribute('data-player-id', player.id); // Add player ID for voting animations

    if (canSelect) {
      playerDiv.onclick = () => {
        if (gameState.gamePhase === 'voting' && canVote) {
          votePlayer(player.id);
        } else if (gameState.gamePhase === 'night') {
          selectPlayer(player.id);
        }
      };
    }
    
    // Add visual indicator if player has been voted by current user
    if (gameState.hasVoted && player.id === gameState.lastVotedPlayer) {
      playerDiv.classList.add('voted-by-me');
    }

    const cardImg = document.createElement('div');
    cardImg.className = 'player-card-img';
    
    if (player.role && room.gameStarted) {
      if (isCurrentUser && player.isAlive) {
        cardImg.style.backgroundImage = `url('img/Backcard.png')`;
      }
      else if (gameState.userRole && gameState.userRole.team === 'werewolf' && 
               player.role.team === 'werewolf' && player.isAlive) {
        const roleImage = roleCardImages[player.role.nameEn] || 'img/Backcard.png';
        cardImg.style.backgroundImage = `url('${roleImage}')`;
      }
      else if (!player.isAlive) {
        const roleImage = roleCardImages[player.role.nameEn] || 'img/Backcard.png';
        cardImg.style.backgroundImage = `url('${roleImage}')`;
      }
      else {
        cardImg.style.backgroundImage = `url('img/Backcard.png')`;
      }
    }
    
    playerDiv.innerHTML = `
      <div class="player-name">${player.nickname || 'Unknown'}</div>
      ${!room.gameStarted ? `<div class="player-ready ${player.isReady ? 'ready' : 'not-ready'}">
        ${player.isReady ? '‡∏û‡∏£‡πâ‡∏≠‡∏°' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°'}
      </div>` : ''}
    `;
    
    playerDiv.insertBefore(cardImg, playerDiv.firstChild);
    playersContainer.appendChild(playerDiv);
  });
  
  const readyBtn = document.getElementById('readyBtn');
  const startBtn = document.getElementById('startGameBtn');
  
  if (room.gameStarted) {
    if (readyBtn) readyBtn.classList.add('hidden');
    if (startBtn) startBtn.classList.add('hidden');
  } else {
    const isHost = room.hostNickname === gameState.currentUser;
    if (readyBtn) readyBtn.classList.toggle('hidden', isHost);
    
    if (!isHost) {
      const currentPlayer = room.players.find(p => p && p.nickname === gameState.currentUser);
      if (currentPlayer && readyBtn) {
        gameState.isReady = currentPlayer.isReady;
        readyBtn.textContent = gameState.isReady ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°' : '‡∏û‡∏£‡πâ‡∏≠‡∏°';
        readyBtn.className = `btn ${gameState.isReady ? 'btn-secondary' : 'btn-primary'}`;
      }
    }
    
    const allReady = room.players.every(p => p && p.isReady);
    const enoughPlayers = (room.playerCount || 0) >= 5;
    if (startBtn) {
      startBtn.classList.toggle('hidden', !isHost || !allReady || !enoughPlayers);
    }
  }
}

function toggleReady() {
  if (!gameState.isConnected) {
    showMessage('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'error');
    return;
  }
  
  socket.emit('toggleReady', (response) => {
    if (response && response.success) {
      gameState.isReady = response.isReady;
      showMessage(gameState.isReady ? '‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß!' : '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°', 'success');
    } else {
      showMessage(response?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ', 'error');
    }
  });
}

function startGame() {
  if (!gameState.isConnected) {
    showMessage('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå', 'error');
    return;
  }
  
  socket.emit('startGame', (response) => {
    if (response && !response.success) {
      showMessage(response.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ', 'error');
    }
  });
}

function flipRoleCard() {
  const roleCard = document.getElementById('roleCardDisplay');
  if (!roleCard) return;
  
  roleCard.classList.toggle('flipped');
  
  setTimeout(() => {
    const moderatorElement = document.getElementById('moderatorMessage');
    if (moderatorElement) {
      if (roleCard.classList.contains('flipped')) {
        moderatorElement.textContent = '‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏´‡πá‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏∞!';
      } else {
        moderatorElement.textContent = '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏¢‡∏±‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢';
      }
    }
  }, 500);
}

function showRoleAssignment(role) {
  if (!role) return;
  
  const roleAssignment = document.getElementById('roleAssignment');
  const roleCardFront = document.getElementById('roleCardFront');
  const roleDescription = document.getElementById('roleDescription');
  const teamIndicator = document.getElementById('teamIndicator');
  
  if (!roleAssignment || !roleCardFront || !roleDescription || !teamIndicator) return;
  
  const roleImage = roleCardImages[role.nameEn] || 'img/Backcard.png';
  roleCardFront.style.backgroundImage = `url('${roleImage}')`;
  
  roleDescription.textContent = `${role.name} - ` + getRoleDescription(role);
  
  teamIndicator.textContent = getTeamName(role.team);
  teamIndicator.className = `team-indicator team-${role.team}`;
  
  if (role.werewolves && role.werewolves.length > 0) {
    const werewolfTeam = document.getElementById('werewolfTeam');
    if (werewolfTeam) {
      werewolfTeam.classList.remove('hidden');
      werewolfTeam.innerHTML = `<div class="message message-info">üê∫ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏µ‡∏°: ${role.werewolves.map(w => w.nickname).join(', ')}</div>`;
    }
  }
  
  roleAssignment.classList.remove('hidden');
}

function getRoleDescription(role) {
  if (!role) return '';
  
  const descriptions = {
    'Villager': '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏´‡∏≤‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤',
    'Seer': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 1 ‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô',
    'Bodyguard': '‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 1 ‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô',
    'Witch': '‡∏°‡∏µ‡∏¢‡∏≤‡∏ä‡∏∏‡∏ö‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡∏û‡∏¥‡∏© 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
    'Wizard': '‡∏õ‡∏¥‡∏î‡∏ú‡∏ô‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 1 ‡∏Ñ‡∏ô',
    'Hunter': '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ 1 ‡∏Ñ‡∏ô',
    'Prostitute': '‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 1 ‡∏Ñ‡∏ô',
    'Werewolf': '‡∏Ü‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏î‡∏µ 1 ‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô',
    'Wolf Cub': '‡∏´‡∏≤‡∏Å‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏ß‡∏ï‡∏ï‡∏≤‡∏¢ ‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏Ü‡πà‡∏≤‡πÑ‡∏î‡πâ 2 ‡∏Ñ‡∏ô',
    'Mermaid': '‡∏™‡∏≤‡∏õ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô 1 ‡∏Ñ‡∏ô‡πÉ‡∏´‡πâ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
    'Minion': '‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£ ‡πÅ‡∏ï‡πà‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ',
    'Village Drunk': '‡∏ä‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏ß‡∏ï‡∏≠‡∏≠‡∏Å'
  };
  return descriptions[role.nameEn] || role.name;
}

function getTeamName(team) {
  const teams = {
    villager: '‡∏ù‡πà‡∏≤‡∏¢‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô',
    werewolf: '‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤',
    neutral: '‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á'
  };
  return teams[team] || team;
}

function startNightPhase(dayNumber) {
  const gamePhaseIndicator = document.getElementById('gamePhaseIndicator');
  const phaseTitle = document.getElementById('phaseTitle');
  
  if (gamePhaseIndicator) gamePhaseIndicator.classList.remove('hidden');
  if (phaseTitle) phaseTitle.textContent = `üåô ‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏µ‡πà ${dayNumber || 1}`;
  
  addGameLog(`üåô ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô... ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤‡∏•‡∏á`, true);
  
  if (gameState.userRole && hasNightAction(gameState.userRole)) {
    showNightAction(gameState.userRole);
  } else {
    const actionArea = document.getElementById('actionArea');
    if (actionArea) actionArea.classList.add('hidden');
    showMessage('‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏™‡∏ö‡∏≤‡∏¢... ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ä‡πâ‡∏≤', 'info');
  }
  
  updateGameRoomDisplay(gameState.currentRoom);
}

function hasNightAction(role) {
  return role && role.abilities && role.abilities.some(a => 
    ['investigate', 'protect', 'kill', 'heal', 'poison', 'seal', 'block_and_protect', 'silence'].includes(a)
  );
}

function showNightAction(role) {
  if (!role || !role.abilities) return;
  
  const actionArea = document.getElementById('actionArea');
  const actionTitle = document.getElementById('actionTitle');
  const actionInstruction = document.getElementById('actionInstruction');
  
  if (!actionArea || !actionTitle || !actionInstruction) return;
  
  actionArea.classList.remove('hidden');
  
  if (role.abilities.includes('kill')) {
    actionTitle.textContent = 'üê∫ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠';
    actionInstruction.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ';
  } else if (role.abilities.includes('investigate')) {
    actionTitle.textContent = 'üîÆ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
    actionInstruction.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
  } else if (role.abilities.includes('protect')) {
    actionTitle.textContent = 'üõ°Ô∏è ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
    actionInstruction.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á';
  }
  
  updateGameRoomDisplay(gameState.currentRoom);
}

function selectPlayer(playerId) {
  if (!playerId) return;
  
  gameState.selectedPlayer = playerId;
  const confirmBtn = document.getElementById('confirmActionBtn');
  if (confirmBtn) confirmBtn.disabled = false;
  
  // Remove previous selections
  document.querySelectorAll('.player-in-room').forEach(p => p.classList.remove('selected'));
  
  // Find and highlight selected player
  if (gameState.currentRoom && gameState.currentRoom.players) {
    const playerIndex = gameState.currentRoom.players.findIndex(p => p && p.id === playerId);
    if (playerIndex >= 0) {
      const playerElements = document.querySelectorAll('.player-in-room');
      if (playerElements[playerIndex]) {
        playerElements[playerIndex].classList.add('selected');
      }
    }
  }
  
  const player = gameState.currentRoom?.players?.find(p => p && p.id === playerId);
  if (player) {
    showMessage(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${player.nickname}`, 'info');
  }
}

function confirmAction() {
  if (!gameState.selectedPlayer || !gameState.isConnected) {
    showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô', 'error');
    return;
  }
  
  socket.emit('nightAction', { target: gameState.selectedPlayer }, (response) => {
    if (response && response.success) {
      const actionArea = document.getElementById('actionArea');
      if (actionArea) actionArea.classList.add('hidden');
      gameState.selectedPlayer = null;
      showMessage('‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô', 'success');
      addGameLog(`‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡πÉ‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß`);
    } else {
      showMessage(response?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡πÑ‡∏î‡πâ', 'error');
    }
  });
}

function startDayPhase(dayNumber) {
  const gamePhaseIndicator = document.getElementById('gamePhaseIndicator');
  const phaseTitle = document.getElementById('phaseTitle');
  
  if (gamePhaseIndicator) gamePhaseIndicator.classList.remove('hidden');
  if (phaseTitle) phaseTitle.textContent = `‚òÄÔ∏è ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayNumber || 1}`;
  
  // Reset voting-related state
  gameState.hasVoted = false;
  gameState.lastVotedPlayer = null;
  
  // Remove voting phase overlay and styling
  document.body.classList.remove('voting-phase');
  const votingStyle = document.getElementById('votingPhaseStyle');
  if (votingStyle) votingStyle.remove();
  
  // Clear any vote styling from players
  document.querySelectorAll('.player-in-room').forEach(div => {
    div.classList.remove('voted-by-me');
    const card = div.querySelector('.player-card-img');
    if (card) card.style.filter = '';
  });
  
  addGameLog(`‚òÄÔ∏è ‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏ä‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà! ‡πÑ‡∏î‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤`, true);
  updateGameRoomDisplay(gameState.currentRoom);
}

function votePlayer(playerId) {
  if (!playerId || !gameState.currentRoom || !gameState.isConnected) {
    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', 'error');
    return;
  }

  if (gameState.hasVoted) {
    showMessage('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'error');
    return;
  }
  
  const player = gameState.currentRoom.players.find(p => p && p.id === playerId);
  if (!player) {
    showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'error');
    return;
  }

  if (!player.isAlive) {
    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏ß‡∏ï‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'error');
    return;
  }
  
  const playerCard = document.querySelector(`[data-player-id="${playerId}"] .player-card-img`);
  if (playerCard) {
    playerCard.classList.add('shake');
    setTimeout(() => {
      playerCard.classList.remove('shake');
      // Show vote confirmation modal
      const modal = document.getElementById('voteConfirmModal');
      const targetNameSpan = modal.querySelector('.vote-target-name');
      const confirmBtn = document.getElementById('confirmVoteBtn');
      const cancelBtn = document.getElementById('cancelVoteBtn');

      if (!modal || !targetNameSpan || !confirmBtn || !cancelBtn) {
        console.error('Required DOM elements for voting not found');
        return;
      }

      targetNameSpan.textContent = player.nickname;
      modal.classList.add('show');

      const handleConfirm = () => {
        if (!socket || !gameState.isConnected) {
          showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', 'error');
          modal.classList.remove('show');
          cleanup();
          return;
        }

        socket.emit('vote', { target: playerId }, (response) => {
          if (response && response.success) {
            gameState.hasVoted = true;
            gameState.lastVotedPlayer = playerId; // Store last voted player
            showMessage(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏ß‡∏ï ${player.nickname} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            addGameLog(`‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏ß‡∏ï ${player.nickname}`);
            
            // Reset vote style for all players first
            document.querySelectorAll('.player-in-room').forEach(div => {
              div.classList.remove('voted-by-me');
              const card = div.querySelector('.player-card-img');
              if (card) card.style.filter = '';
            });

            // Apply vote style to selected player
            const playerDiv = document.querySelector(`[data-player-id="${playerId}"]`);
            if (playerDiv) {
              playerDiv.classList.add('voted-by-me');
              const card = playerDiv.querySelector('.player-card-img');
              if (card) card.style.filter = 'brightness(0.7)';
            }

            updateGameRoomDisplay(gameState.currentRoom);
          } else {
            showMessage(response?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏ß‡∏ï‡πÑ‡∏î‡πâ', 'error');
            gameState.hasVoted = false;
            gameState.lastVotedPlayer = null;
          }
        });
        modal.classList.remove('show');
        cleanup();
      };

      const handleCancel = () => {
        modal.classList.remove('show');
        cleanup();
      };

      const handleOutsideClick = (e) => {
        if (e.target === modal) {
          modal.classList.remove('show');
          cleanup();
        }
      };

      const cleanup = () => {
        if (confirmBtn) confirmBtn.removeEventListener('click', handleConfirm);
        if (cancelBtn) cancelBtn.removeEventListener('click', handleCancel);
        if (modal) modal.removeEventListener('click', handleOutsideClick);
      };

      confirmBtn.addEventListener('click', handleConfirm);
      cancelBtn.addEventListener('click', handleCancel);
      modal.addEventListener('click', handleOutsideClick);
    }, 500); // Wait for shake animation to finish
  }
}

function startVotingPhase() {
  gameState.gamePhase = 'voting';
  gameState.hasVoted = false;
  gameState.lastVotedPlayer = null; // Reset last voted player
  
  const phaseTitle = document.getElementById('phaseTitle');
  if (phaseTitle) phaseTitle.textContent = 'üó≥Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏´‡∏ß‡∏ï';

  // Clear any previous vote styling
  document.querySelectorAll('.player-in-room').forEach(div => {
    div.classList.remove('voted-by-me');
    const card = div.querySelector('.player-card-img');
    if (card) card.style.filter = '';
  });

  // ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ü‡∏™‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° overlay ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ü‡∏™‡πÇ‡∏´‡∏ß‡∏ï
  document.body.classList.remove('night');
  document.body.classList.add('day');
  
  // Clean up old voting phase style if exists
  const oldStyle = document.getElementById('votingPhaseStyle');
  if (oldStyle) oldStyle.remove();
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö voting phase overlay
  const style = document.createElement('style');
  style.id = 'votingPhaseStyle';
  style.textContent = `
    body.day.voting-phase::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 1;
      pointer-events: none;
    }
    .player-in-room.voted-by-me {
      border-color: #ff9800;
      box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
    }
    .player-in-room.selectable:hover .player-card-img {
      transform: translateY(-10px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.4);
      transition: all 0.3s ease;
    }
  `;
  document.head.appendChild(style);
  document.body.classList.add('voting-phase');

  addGameLog(`üó≥Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï! ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏á‡∏™‡∏±‡∏¢`, true);
  showMessage('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï‡∏≠‡∏≠‡∏Å', 'info');

  const actionArea = document.getElementById('actionArea');
  if (actionArea) actionArea.classList.add('hidden');

  updateGameRoomDisplay(gameState.currentRoom);
}

function startPhaseTimer(durationInSeconds) {
  if (phaseTimer) {
    clearInterval(phaseTimer);
  }
  
  let remainingTime = Math.max(0, durationInSeconds);
  const timerDisplay = document.getElementById('timerDisplay');
  const timerTime = document.getElementById('timerTime');
  
  if (timerDisplay) timerDisplay.classList.remove('hidden');
  
  updateTimerDisplay(remainingTime);
  
  phaseTimer = setInterval(() => {
    remainingTime--;
    updateTimerDisplay(remainingTime);
    
    if (remainingTime <= 0) {
      clearInterval(phaseTimer);
      phaseTimer = null;
      if (timerTime) timerTime.textContent = '00:00';
    }
  }, 1000);
}

function updateTimerDisplay(seconds) {
  const timerTime = document.getElementById('timerTime');
  if (!timerTime) return;
  
  const minutes = Math.floor(Math.max(0, seconds) / 60);
  const secs = Math.max(0, seconds) % 60;
  timerTime.textContent = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
  
  if (seconds <= 10) {
    timerTime.style.color = '#ff4444';
  } else if (seconds <= 30) {
    timerTime.style.color = '#ff9800';
  } else {
    timerTime.style.color = '#ff6b6b';
  }
}

// Event listeners and initialization
document.addEventListener('DOMContentLoaded', function() {
  initSocket();
  
  const nicknameInput = document.getElementById('nicknameInput');
  const roomNameInput = document.getElementById('roomName');
  
  if (nicknameInput) {
    nicknameInput.focus();
    nicknameInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        setNickname();
      }
    });
  }
  
  if (roomNameInput) {
    roomNameInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        createRoom();
      }
    });
  }
  
  // Handle page visibility changes
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible' && !gameState.isConnected) {
      initSocket();
    }
  });
  
  // Handle window beforeunload
  window.addEventListener('beforeunload', function() {
    if (socket && socket.connected) {
      socket.disconnect();
    }
  });
});
</script>

</body>
</html>